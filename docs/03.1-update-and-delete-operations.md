```markdown
docs/03.1-update-and-delete-operations.md
# 03.1 - Продвинутые Операции Обновления и Удаления

В этом разделе рассматриваются расширенные методы для изменения и удаления документов, которые предоставляют больше гибкости и мощи по сравнению с базовыми `update` и `remove`. Эти методы используют синтаксис, схожий с MongoDB, включая фильтры и операторы обновления.

**Предполагается, что у вас уже есть инициализированный экземпляр `WiseJSON` и получен экземпляр коллекции, как описано в предыдущих разделах.**

## Продвинутое Обновление Документов

В отличие от базового метода `collection.update()`, который полностью заменяет данные документа (кроме `_id` и `createdAt`), новые методы `updateOne()` и `updateMany()` позволяют производить атомарные изменения отдельных полей с помощью **операторов обновления**.

### Операторы Обновления

*   `$set`: Устанавливает значение поля. Если поля нет, оно будет создано.
*   `$inc`: Увеличивает (или уменьшает при отрицательном значении) числовое значение поля на указанную величину.
*   `$unset`: Полностью удаляет указанное поле из документа.
*   `$push`: Добавляет элемент в поле-массив.
*   `$pull`: Удаляет все вхождения указанного значения из поля-массива.
*   *... и другие, которые могут быть добавлены в будущем.*

### Обновление одного документа (`updateOne`)

Метод `collection.updateOne(filter, update)` находит **первый** документ, соответствующий `filter`, и применяет к нему изменения, описанные в `update`.

*   **Параметры:**
    *   `filter {object}`: Объект-фильтр (как в `find`) для поиска документа, который нужно обновить.
    *   `update {object}`: Объект, описывающий изменения. Должен содержать операторы обновления.
*   **Возвращает:** `Promise<{ matchedCount: number, modifiedCount: number }>`
    *   `matchedCount`: Количество найденных документов (0 или 1).
    *   `modifiedCount`: Количество реально измененных документов (0 или 1).

**Пример:**
```javascript
// Увеличить возраст пользователя 'Alice' на 1 и установить ей новый статус
const filter = { name: 'Alice' };
const update = {
  $inc: { age: 1 },
  $set: { status: 'active', lastSeen: new Date().toISOString() }
};

const result = await usersCollection.updateOne(filter, update);

console.log(`Найдено: ${result.matchedCount}, изменено: ${result.modifiedCount}`);
// Вывод: Найдено: 1, изменено: 1
```

### Обновление нескольких документов (`updateMany`)

Метод `collection.updateMany(filter, update)` работает аналогично `updateOne`, но применяет изменения ко **всем** документам, которые соответствуют `filter`.

*   **Параметры:** Аналогичны `updateOne`.
*   **Возвращает:** `Promise<{ matchedCount: number, modifiedCount: number }>`

**Пример:**
```javascript
// Дать скидку 10% на все книги в наличии
const filter = { category: 'books', inStock: true };
const update = { $set: { onSale: true, discount: 0.1 } };

const result = await productsCollection.updateMany(filter, update);

console.log(`Найдено товаров для скидки: ${result.matchedCount}, обновлено: ${result.modifiedCount}`);
```

### Найти и обновить (`findOneAndUpdate`)

Этот метод атомарно находит один документ, обновляет его и возвращает. Это очень полезно, когда нужно получить документ в его старом или новом состоянии сразу после изменения.

*   **Параметры:**
    *   `filter {object}`: Фильтр для поиска документа.
    *   `update {object}`: Объект с операторами обновления.
    *   `options {object}` (необязательно):
        *   `returnOriginal {boolean}`: Если `false` (по умолчанию), возвращает документ **после** обновления. Если `true`, возвращает документ **до** обновления.
*   **Возвращает:** `Promise<object | null>` - Документ (до или после обновления) или `null`, если ничего не найдено.

**Пример:**
```javascript
// Зарезервировать один товар и вернуть его состояние *до* резервации
const filter = { name: 'Product A', stock: { $gt: 0 } };
const update = { $inc: { stock: -1 } };
const options = { returnOriginal: true };

const originalProductState = await productsCollection.findOneAndUpdate(filter, update, options);

if (originalProductState) {
  console.log(`Товар успешно зарезервирован. Остаток на складе был: ${originalProductState.stock}`);
} else {
  console.log('Товара нет в наличии или он не найден.');
}
```

## Продвинутое Удаление Документов

### Удаление одного документа (`deleteOne`)

Метод `collection.deleteOne(filter)` удаляет **первый** документ, соответствующий `filter`.

*   **Параметры:**
    *   `filter {object}`: Фильтр для поиска документа на удаление.
*   **Возвращает:** `Promise<{ deletedCount: number }>` - Объект, где `deletedCount` равен 0 или 1.

**Пример:**
```javascript
// Удалить один неактивный лог
const result = await logsCollection.deleteOne({ level: 'debug', processed: true });
console.log(`Удалено логов: ${result.deletedCount}`);
```

### Удаление нескольких документов (`deleteMany`)

Метод `collection.deleteMany(filter)` удаляет **все** документы, соответствующие `filter`.

*   **Параметры:**
    *   `filter {object}`: Фильтр для поиска документов на удаление.
*   **Возвращает:** `Promise<{ deletedCount: number }>` - Объект с количеством удаленных документов.

**Пример:**
```javascript
// Удалить все сессии пользователя, которые истекли
const filter = {
  userId: 'user-123',
  expiresAt: { $lt: new Date().toISOString() }
};

const result = await sessionsCollection.deleteMany(filter);
console.log(`Удалено устаревших сессий: ${result.deletedCount}`);
```
Использование этих методов позволяет писать более выразительный и мощный код для манипуляции данными, приближаясь к возможностям полнофункциональных NoSQL баз данных.