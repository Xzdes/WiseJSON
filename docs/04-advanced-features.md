```markdown
docs/04-advanced-features.md
# 04 - Расширенные Возможности и Конфигурация

В этом разделе рассматриваются дополнительные возможности WiseJSON DB, такие как настройка экземпляра базы данных, импорт и экспорт данных, а также краткое руководство по использованию интерфейса командной строки (CLI) для администрирования.

## Конфигурация Экземпляра `WiseJSON`

При создании нового экземпляра `WiseJSON` вы можете передать второй аргумент — объект с опциями конфигурации, чтобы настроить поведение базы данных под ваши нужды.

**Синтаксис:**

```javascript
const db = new WiseJSON(dbPath, options);
```

*   `dbPath {string}`: Путь к директории базы данных.
*   `options {object}`: Объект с параметрами конфигурации.

**Основные доступные опции:**

*   **`ttlCleanupIntervalMs {number}`**
    *   **Описание:** Интервал в миллисекундах, с которым база данных будет автоматически проверять и удалять документы с истекшим временем жизни (TTL).
    *   **Значение по умолчанию:** `60000` (1 минута).
    *   **Когда менять:** Уменьшите значение для более частой очистки (например, если у вас много короткоживущих данных), или увеличьте для снижения нагрузки, если частая очистка не критична. Установка в `0` или отрицательное значение может отключить автоматическую очистку по таймеру (но TTL все равно будет проверяться при некоторых операциях чтения).

*   **`checkpointIntervalMs {number}`**
    *   **Описание:** Интервал в миллисекундах, с которым база данных будет автоматически создавать чекпоинт (полный снимок состояния) для каждой коллекции. Чекпоинты ускоряют восстановление после сбоев и позволяют очищать старые записи из WAL-файла.
    *   **Значение по умолчанию:** `300000` (5 минут).
    *   **Когда менять:** Уменьшите для более частых сохранений состояния (повышает надежность, но может немного увеличить нагрузку). Увеличьте, если операции записи редкие или если небольшая задержка в сохранении состояния допустима. `0` или отрицательное значение отключает чекпоинты по таймеру (но они могут создаваться по другим триггерам, см. `maxWalEntriesBeforeCheckpoint`).

*   **`maxWalEntriesBeforeCheckpoint {number}`**
    *   **Описание:** Максимальное количество записей в WAL-файле коллекции, после которого будет принудительно создан чекпоинт, даже если интервал `checkpointIntervalMs` еще не истек. Это помогает ограничить размер WAL-файла.
    *   **Значение по умолчанию:** `1000`.
    *   **Когда менять:** Если у вас очень интенсивная запись, возможно, стоит уменьшить это значение для более частых чекпоинтов и меньших WAL-файлов. Если запись редкая, можно увеличить или отключить (`0` или отрицательное значение).

*   **`checkpointsToKeep {number}`**
    *   **Описание:** Количество последних чекпоинтов, которые будут храниться на диске для каждой коллекции. Более старые чекпоинты автоматически удаляются.
    *   **Значение по умолчанию:** `5`.
    *   **Минимальное значение:** `1`.
    *   **Когда менять:** Увеличьте, если вам нужна возможность отката к более старым состояниям (хотя WiseJSON DB не предоставляет прямого API для отката к конкретному чекпоинту, файлы остаются). Уменьшите для экономии места на диске.

*   **`idGenerator {function}`**
    *   **Описание:** Позволяет определить собственную функцию для генерации значений поля `_id` для новых документов, если `_id` не предоставлен явно при вставке.
    *   **Функция должна:** Не принимать аргументов и возвращать уникальную строку.
    *   **Значение по умолчанию:** Внутренний генератор, основанный на `uuid`.
    *   **Когда менять:** Если у вас есть специфические требования к формату `_id` или вы хотите использовать другую библиотеку для генерации UUID (например, `nanoid`).

*   **`walReadOptions {object}`**
    *   **Описание:** Опции, передаваемые в `wal-manager.readWal` при инициализации коллекции для обработки возможно поврежденных строк в WAL-файле.
    *   **Значение по умолчанию:** `{ recover: false, strict: false }` (поврежденные строки пропускаются с предупреждением).
    *   **Опции внутри `walReadOptions`:**
        *   `recover {boolean}`: Если `true`, WiseJSON DB попытается восстановить как можно больше данных, пропуская отдельные поврежденные строки в WAL с выводом предупреждения.
        *   `strict {boolean}`: Если `true`, при обнаружении первой же ошибки парсинга строки в WAL будет выброшена ошибка, и инициализация коллекции может прерваться.
    *   **Когда менять:** Обычно значения по умолчанию подходят. `recover: true` может быть полезно, если вы подозреваете повреждение WAL и хотите попытаться спасти максимум данных, даже если некоторые операции будут пропущены. `strict: true` может быть использовано для более строгой проверки целостности при запуске.

**Пример использования опций:**

```javascript
const WiseJSON = require('wise-json-db');
const path = require('path');
const { v4: uuidv4 } = require('uuid'); // Пример использования внешней библиотеки для ID

async function configureDatabase() {
  const dbPath = path.resolve(__dirname, 'myConfiguredDb');
  let db;

  const dbOptions = {
    ttlCleanupIntervalMs: 30 * 60 * 1000, // Проверять TTL каждые 30 минут
    checkpointIntervalMs: 10 * 60 * 1000, // Чекпоинт каждые 10 минут
    maxWalEntriesBeforeCheckpoint: 5000,  // Чекпоинт после 5000 записей в WAL
    checkpointsToKeep: 3,                 // Хранить 3 последних чекпоинта
    idGenerator: () => `doc-${uuidv4()}`, // Кастомный генератор ID с префиксом
    walReadOptions: { recover: true }     // Пытаться восстановить из поврежденного WAL
  };

  try {
    db = new WiseJSON(dbPath, dbOptions);
    await db.init();
    console.log('База данных сконфигурирована и инициализирована.');

    const items = await db.collection('items');
    await items.initPromise;

    const newItem = await items.insert({ name: 'Конфигурируемый элемент' });
    console.log('Новый элемент с кастомным ID:', newItem); // _id будет вида 'doc-xxxxxxxx-xxxx...'

  } catch (error) {
    console.error('Ошибка при работе с сконфигурированной БД:', error);
  } finally {
    if (db) {
      await db.close();
    }
  }
}

configureDatabase();
```

## Импорт и Экспорт Данных

WiseJSON DB предоставляет методы для простого экспорта данных коллекции в файлы и импорта из них.

### Как экспортировать коллекцию в JSON-файл (`exportJson`)

Метод `collection.exportJson(filePath)` сохраняет все "живые" документы из коллекции в указанный файл в формате JSON (массив объектов).

*   **Параметры:**
    *   `filePath {string}`: Полный путь к файлу, в который будут экспортированы данные. Если файл существует, он будет перезаписан.
*   **Возвращает:** `Promise<void>` - Промис, который разрешается после успешного завершения экспорта.

**Пример:**

```javascript
// ... (инициализация db и получение коллекции `myCollection`) ...
const exportFilePath = path.resolve(__dirname, 'myCollection_export.json');
try {
  await myCollection.exportJson(exportFilePath);
  console.log(`Коллекция успешно экспортирована в ${exportFilePath}`);
} catch (error) {
  console.error(`Ошибка экспорта в JSON: ${error.message}`);
}
// ... (db.close()) ...
```

### Как экспортировать коллекцию в CSV-файл (`exportCsv`)

Метод `collection.exportCsv(filePath)` сохраняет все "живые" документы из коллекции в указанный файл в формате CSV. Первая строка CSV-файла будет содержать заголовки (имена полей), а последующие строки — значения этих полей для каждого документа.

*   **Параметры:**
    *   `filePath {string}`: Полный путь к CSV-файлу. Файл будет перезаписан, если существует.
*   **Возвращает:** `Promise<void>` - Промис, разрешающийся после успешного экспорта.

**Пример:**

```javascript
// ... (инициализация db и получение коллекции `myCollection`) ...
const exportCsvPath = path.resolve(__dirname, 'myCollection_export.csv');
try {
  await myCollection.exportCsv(exportCsvPath);
  console.log(`Коллекция успешно экспортирована в ${exportCsvPath}`);
} catch (error) {
  console.error(`Ошибка экспорта в CSV: ${error.message}`);
}
// ... (db.close()) ...
```

### Как импортировать документы из JSON-файла (`importJson`)

Метод `collection.importJson(filePath, options)` читает массив документов из JSON-файла и добавляет их в коллекцию.

*   **Параметры:**
    *   `filePath {string}`: Путь к JSON-файлу. Файл должен содержать валидный JSON-массив объектов.
    *   `options {object}` (опционально): Объект с опциями импорта.
        *   `options.mode {string}`: Режим импорта. Может быть:
            *   `'append'` (по умолчанию): Документы из файла добавляются к уже существующим в коллекции.
            *   `'replace'`: Перед импортом все существующие документы в коллекции удаляются (эквивалентно вызову `collection.clear()` перед вставкой).
*   **Возвращает:** `Promise<void>` - Промис, который разрешается после завершения импорта. (Фактически, он использует `insertMany` внутри, поэтому возвращаемое значение `insertMany` — массив вставленных документов — здесь не возвращается наружу из `importJson`, который возвращает `void`).
*   **Ошибки:** Может выбросить ошибку, если файл не найден, содержит невалидный JSON, или если во время `insertMany` возникает ошибка (например, нарушение уникального индекса).

**Пример:**

```javascript
// ... (инициализация db и получение коллекции `myCollection`) ...
// Предположим, у нас есть файл 'import_data.json' со следующим содержимым:
// [
//   { "_id": "item101", "name": "Импортированный товар 1", "price": 100 },
//   { "name": "Импортированный товар 2", "price": 200 }
// ]
const importFilePath = path.resolve(__dirname, 'import_data.json');

// Создадим файл для примера
// const fs = require('fs/promises'); // Если еще не подключен
// await fs.writeFile(importFilePath, JSON.stringify([
//   { "_id": "item101", "name": "Импортированный товар 1", "price": 100 },
//   { "name": "Импортированный товар 2", "price": 200 }
// ], null, 2));

try {
  // Импорт в режиме 'append'
  await myCollection.importJson(importFilePath, { mode: 'append' });
  console.log(`Документы из ${importFilePath} успешно добавлены (append).`);

  // Импорт в режиме 'replace' (перезатрет предыдущие, если они были)
  // await myCollection.importJson(importFilePath, { mode: 'replace' });
  // console.log(`Документы из ${importFilePath} успешно импортированы с заменой (replace).`);

  const allDocs = await myCollection.getAll();
  console.log(`Всего документов в коллекции после импорта: ${allDocs.length}`);
  allDocs.forEach(doc => console.log(doc));

} catch (error) {
  console.error(`Ошибка импорта из JSON: ${error.message}`);
}
// ... (db.close()) ...
```

## Командная Строка (CLI) для Быстрого Администрирования (Краткая Справка)

WiseJSON DB включает два инструмента командной строки:
1.  **`wise-json`** (или `wise-json-cli`): Базовый CLI для основных операций.
2.  **`wisejson-explorer`**: Более продвинутый CLI, также служащий бэкендом для веб-интерфейса Data Explorer.

Эти утилиты могут быть полезны для быстрого просмотра данных, экспорта, импорта или управления индексами без написания кода.

**Основные моменты при использовании CLI:**

*   **`WISE_JSON_PATH`**: Убедитесь, что переменная окружения `WISE_JSON_PATH` установлена и указывает на директорию вашей базы данных, если она отличается от пути по умолчанию (`./wise-json-db-data`).
    ```bash
    export WISE_JSON_PATH=/путь/к/вашей/бд  # для Linux/macOS
    set WISE_JSON_PATH=C:\путь\к\вашей\бд   # для Windows (cmd)
    $env:WISE_JSON_PATH="C:\путь\к\вашей\бд" # для Windows (PowerShell)
    ```
    Или передавайте путь при каждом вызове, если CLI это поддерживает (см. `wise-json --help`).
*   **Глобальная установка (опционально)**: Для удобства можно установить `wise-json-db` глобально (`npm install -g wise-json-db`), тогда команды `wise-json` и `wisejson-explorer` будут доступны напрямую. В противном случае используйте `npx wise-json ...` или пути к скриптам из `node_modules/.bin/`.

**Некоторые полезные команды `wise-json`:**

*   **Посмотреть список коллекций:**
    ```bash
    wise-json list
    ```
*   **Посмотреть информацию о коллекции (статистика, индексы):**
    ```bash
    wise-json info <имя_коллекции>
    ```
*   **Найти документы в коллекции (фильтр - JSON строка):**
    ```bash
    wise-json find <имя_коллекции> '{"возраст":{"$gt":30}}'
    wise-json find <имя_коллекции> '{"$or":[{"город":"Москва"},{"теги":{"$in":["dev"]}}]}'
    ```
*   **Получить документ по ID:**
    ```bash
    wise-json get <имя_коллекции> <ID_документа>
    ```
*   **Экспортировать коллекцию:**
    ```bash
    wise-json export <имя_коллекции> <путь_к_файлу.json>
    ```
*   **Импортировать документы в коллекцию:**
    ```bash
    wise-json import <имя_коллекции> <путь_к_файлу.json>
    ```
*   **Получить справку:**
    ```bash
    wise-json help
    ```

**Некоторые полезные команды `wisejson-explorer`:**

*   **Посмотреть список коллекций:**
    ```bash
    wisejson-explorer list-collections
    ```
*   **Показать документы коллекции с фильтрацией, сортировкой, пагинацией:**
    ```bash
    wisejson-explorer show-collection <имя_коллекции> --limit 5 --offset 0 --sort age --order desc --filter '{"город":"Лондон"}'
    ```
*   **Экспортировать коллекцию в JSON или CSV:**
    ```bash
    wisejson-explorer export-collection <имя_коллекции> data.json
    wisejson-explorer export-collection <имя_коллекции> data.csv --output csv
    ```
*   **Импортировать данные (требует `--allow-write` для изменения данных):**
    ```bash
    wisejson-explorer import-collection <имя_коллекции> data.json --mode replace --allow-write
    ```
*   **Управлять индексами (требует `--allow-write` для изменения данных):**
    ```bash
    wisejson-explorer list-indexes <имя_коллекции>
    wisejson-explorer create-index <имя_коллекции> <имя_поля> --unique --allow-write
    wisejson-explorer drop-index <имя_коллекции> <имя_поля> --allow-write
    ```
*   **Получить справку:**
    ```bash
    wisejson-explorer --help
    ```

Для более детальной информации по всем командам и опциям CLI, обратитесь к выводу `help` соответствующей утилиты или к основному файлу `README.md` проекта.

Веб-интерфейс **Data Explorer** (запускается командой `wisejson-explorer-server` или `node explorer/server.js`) предоставляет удобный графический способ для просмотра и базового управления данными.