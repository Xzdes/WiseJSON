```markdown
docs/02-querying-and-indexing.md
# 02 - Запросы к Данным и Индексирование

Этот раздел посвящен тому, как извлекать документы из коллекций WiseJSON DB. Мы рассмотрим как базовый поиск по ID, так и мощные запросы с использованием фильтров, операторов и индексов для ускорения операций.

**Предполагается, что у вас уже есть инициализированный экземпляр `WiseJSON` и рабочая коллекция, как описано в предыдущих разделах.**

## Базовые Методы Чтения

### Как получить документ по его ID (`getById`)

Это самый быстрый и прямой способ получить один конкретный документ, если вы знаете его уникальный идентификатор `_id`.

*   **Параметры:**
    *   `id {string}`: Уникальный `_id` искомого документа.
*   **Возвращает:** `Promise<object | null>` - Промис, который разрешается объектом найденного документа. Если документ с таким `id` не существует или его срок жизни (TTL) истек, промис разрешается значением `null`.

**Пример:**

```javascript
const article = await articlesCollection.getById('article-123');
if (article) {
  console.log('Найдена статья:', article);
} else {
  console.log('Статья с ID "article-123" не найдена.');
}
```

### Как получить все документы из коллекции (`getAll`)

Метод `collection.getAll()` извлекает все "живые" (не истекшие по TTL) документы из коллекции.

*   **Внимание:** Используйте этот метод с осторожностью на очень больших коллекциях, так как он загружает все документы в оперативную память.
*   **Параметры:** Нет.
*   **Возвращает:** `Promise<Array<object>>` - Промис, который разрешается массивом всех найденных документов.

**Пример:**

```javascript
const allTasks = await tasksCollection.getAll();
console.log(`Всего найдено ${allTasks.length} задач.`);
```

## Продвинутые Запросы с `find` и `findOne`

Для гибкого поиска по различным критериям WiseJSON DB предоставляет методы `find` и `findOne`, которые поддерживают мощный синтаксис запросов, аналогичный MongoDB.

### Поиск нескольких документов по условию (`find`)

Метод `collection.find(query, projection)` позволяет найти все документы, которые удовлетворяют заданному фильтру.

*   **Параметры:**
    *   `query {object}`: Объект-фильтр, описывающий условия поиска. Это основной и рекомендуемый способ.
    *   `projection {object}` (необязательно): Объект, указывающий, какие поля следует включить или исключить из результирующих документов (см. ниже).
*   **Возвращает:** `Promise<Array<object>>` - Промис, который разрешается массивом документов, соответствующих запросу.

#### Синтаксис Запросов (Query Syntax)

Объект-фильтр состоит из пар `поле: значение` для точного совпадения или использует специальные операторы для более сложных условий.

**Операторы сравнения:**
*   `$eq`: равно (обычно опускается, ` { age: 30 } ` эквивалентно ` { age: { $eq: 30 } } `)
*   `$ne`: не равно (`!=`)
*   `$gt`: больше чем (`>`)
*   `$gte`: больше или равно (`>=`)
*   `$lt`: меньше чем (`<`)
*   `$lte`: меньше или равно (`<=`)
*   `$in`: значение поля находится в указанном массиве
*   `$nin`: значение поля не находится в указанном массиве

**Логические операторы:**
*   `$or`: соответствует любому из условий в массиве. ` { $or: [ { <условие1> }, { <условие2> } ] } `
*   `$and`: соответствует всем условиям в массиве. Обычно неявно, но полезен для сложных группировок.

**Операторы элементов:**
*   `$exists`: поле существует (`true`) или не существует (`false`).

**Пример 1: Простой фильтр**
Найти всех пользователей из города 'Москва'.
```javascript
const moscowUsers = await usersCollection.find({ city: 'Москва' });
```

**Пример 2: Использование операторов сравнения**
Найти всех пользователей старше 30 лет, но младше 40.
```javascript
const usersInTheir30s = await usersCollection.find({
  age: { $gt: 30, $lt: 40 }
});
```

**Пример 3: Использование оператора `$in`**
Найти товары из категорий 'Электроника' или 'Книги'.
```javascript
const desiredProducts = await productsCollection.find({
  category: { $in: ['Электроника', 'Книги'] }
});
```

**Пример 4: Сложный запрос с логикой `$or`**
Найти всех активных пользователей из Нью-Йорка ИЛИ всех пользователей с тегом 'vip'.
```javascript
const query = {
  $or: [
    { city: 'New York', status: 'active' }, // Условие 1
    { tags: 'vip' } // Условие 2 (для полей-массивов простое совпадение работает как "содержит")
  ]
};
const results = await usersCollection.find(query);
```

### Поиск одного документа по условию (`findOne`)

Работает аналогично `find`, но возвращает только **первый** найденный документ, удовлетворяющий условию, или `null`. Это более эффективно, если вам нужен только один результат или вы проверяете наличие документа.

*   **Параметры и Возвращаемое значение:** Аналогичны `find`, но возвращает `Promise<object | null>`.

**Пример:**
Найти одного пользователя с email 'admin@example.com'.
```javascript
const adminUser = await usersCollection.findOne({ email: 'admin@example.com' });
if (adminUser) {
  console.log('Администратор найден:', adminUser);
}
```

### Проекции: Выборка нужных полей

Иногда вам не нужны все поля документа, а только некоторые из них. Проекции позволяют указать, какие поля **включить** или **исключить** из результата. Это уменьшает объем передаваемых данных и может повысить производительность.

Проекции передаются вторым аргументом в `find` и `findOne`.
*   `{ field: 1 }`: Включить поле `field`.
*   `{ field: 0 }`: Исключить поле `field`.

**Правила:**
1.  Вы не можете смешивать режимы включения и исключения в одном объекте проекции (кроме особого случая с исключением `_id`).
2.  Поле `_id` включается по умолчанию. Чтобы его исключить, нужно явно указать `{ _id: 0 }`.

**Пример 1: Включение конкретных полей**
Получить только имена и email всех пользователей, оставив `_id` по умолчанию.
```javascript
const userList = await usersCollection.find({}, { name: 1, email: 1 });
// Результат: [{ _id: '...', name: '...', email: '...' }, ...]
```

**Пример 2: Включение полей с исключением `_id`**
```javascript
const userListNoId = await usersCollection.find({}, { name: 1, email: 1, _id: 0 });
// Результат: [{ name: '...', email: '...' }, ...]
```

**Пример 3: Исключение полей**
Получить все данные о пользователях, кроме их детальной истории и тегов.
```javascript
const usersWithoutHistory = await usersCollection.find({}, { history: 0, tags: 0 });
```

## Ускорение Поиска с Помощью Индексов

Индексы — это специальные структуры данных, которые позволяют базе данных находить документы гораздо быстрее, не перебирая всю коллекцию. WiseJSON DB **автоматически использует существующие индексы**, если поле в запросе проиндексировано и используется для поиска по точному совпадению (`{ field: 'value' }`) или с операторами диапазона (`$gt`, `$lt` и т.д.).

### Как создать индекс (`createIndex`)

Метод `collection.createIndex(fieldName, options)` создает индекс для указанного поля.

*   **Параметры:**
    *   `fieldName {string}`: Имя индексируемого поля.
    *   `options {object}` (необязательно):
        *   `unique {boolean}`: Если `true`, индекс будет уникальным. Это гарантирует, что не будет двух документов с одинаковым значением в этом поле. Попытка вставить дубликат вызовет ошибку. По умолчанию `false`.

**Пример:**
```javascript
// Создаем стандартный (неуникальный) индекс по полю 'city' для быстрого поиска по городам
await customersCollection.createIndex('city');

// Создаем уникальный индекс по полю 'email', чтобы не было двух пользователей с одинаковым email
await customersCollection.createIndex('email', { unique: true });
```

### Управление индексами

*   **`collection.getIndexes()`**: Возвращает массив объектов, описывающих все существующие индексы в коллекции.
    ```javascript
    const indexes = await customersCollection.getIndexes();
    // Пример вывода: [{ fieldName: 'city', type: 'standard' }, { fieldName: 'email', type: 'unique' }]
    console.log('Текущие индексы:', indexes);
    ```
*   **`collection.dropIndex(fieldName)`**: Удаляет индекс с указанного поля.
    ```javascript
    await customersCollection.dropIndex('city');
    console.log('Индекс по полю "city" удален.');
    ```

### Методы поиска по индексу (для обратной совместимости)

Хотя современный метод `find` автоматически использует индексы, для обратной совместимости и в некоторых случаях для явного указания поиска по индексу сохранены следующие методы. Они могут быть менее гибкими, чем `find`.

*   **`collection.findByIndexedValue(fieldName, value)`**: Находит все документы с точным значением `value` в индексированном поле `fieldName`. Это эквивалентно `find({ [fieldName]: value })`.
*   **`collection.findOneByIndexedValue(fieldName, value)`**: Находит один документ. Эквивалент `findOne({ [fieldName]: value })`.

**Пример:**
```javascript
// Эти два вызова дадут одинаковый результат, но `find` более универсален.
const usersFromSpb_legacy = await usersCollection.findByIndexedValue('city', 'Санкт-Петербург');
const usersFromSpb_modern = await usersCollection.find({ city: 'Санкт-Петербург' });
```
