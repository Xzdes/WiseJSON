```markdown
docs/02-querying-and-indexing.md
# 02 - Запросы к Данным и Индексирование

Этот раздел посвящен тому, как извлекать документы из коллекций WiseJSON DB. Мы рассмотрим как базовый поиск по ID, так и продвинутые запросы с фильтрами и использованием индексов для ускорения операций.

**Предполагается, что у вас уже есть инициализированный экземпляр `WiseJSON` (переменная `db`) и получен экземпляр коллекции с дождавшимся `initPromise` (переменная `collection`), как описано в разделе `00-introduction-and-setup.md`.**

## Базовые Методы Чтения

### Как получить документ по его ID (`getById`)

Это самый быстрый способ получить один конкретный документ, если вы знаете его уникальный идентификатор `_id`.

*   **Параметры:**
    *   `id {string}`: Уникальный `_id` искомого документа.
*   **Возвращает:** `Promise<object | null>` - Промис, который разрешается объектом найденного документа. Если документ с таким `id` не существует или его срок жизни (TTL) истек, промис разрешается значением `null`.

**Пример:**

```javascript
const article = await articlesCollection.getById('article-123');
if (article) {
  console.log('Найдена статья:', article);
} else {
  console.log('Статья не найдена.');
}
```

### Как получить все документы из коллекции (`getAll`)

Метод `collection.getAll()` извлекает все "живые" (не истекшие по TTL) документы из коллекции. Используйте его с осторожностью на очень больших коллекциях, так как он загружает все документы в память.

*   **Параметры:** Нет.
*   **Возвращает:** `Promise<Array<object>>` - Промис, который разрешается массивом всех найденных документов.

**Пример:**

```javascript
const allTasks = await tasksCollection.getAll();
console.log(`Найдено ${allTasks.length} задач.`);
```

## Продвинутые Запросы с `find` и `findOne`

WiseJSON DB поддерживает мощный синтаксис запросов, аналогичный MongoDB, что позволяет вам гибко фильтровать данные.

### Поиск документов по условию (`find`)

Метод `collection.find(query, projection)` позволяет найти все документы, которые удовлетворяют определенному условию (фильтру).

*   **Параметры:**
    *   `query {object | function}`:
        *   **(Рекомендуемый способ)** Объект-фильтр, описывающий условия поиска.
        *   **(Для обратной совместимости)** Функция-предикат, которая вызывается для каждого документа и возвращает `true`, если документ подходит.
    *   `projection {object}` (необязательно): Объект, указывающий, какие поля следует включить или исключить из результирующих документов.
*   **Возвращает:** `Promise<Array<object>>` - Промис, который разрешается массивом документов, соответствующих запросу.

#### Использование объекта-фильтра (Query Object)

Это наиболее мощный и предпочтительный способ. Вы можете использовать различные операторы для построения сложных запросов.

**Основные операторы сравнения:**
*   `$gt`: больше чем (`>`)
*   `$gte`: больше или равно (`>=`)
*   `$lt`: меньше чем (`<`)
*   `$lte`: меньше или равно (`<=`)
*   `$ne`: не равно (`!=`)
*   `$in`: значение находится в массиве
*   `$nin`: значение не находится в массиве
*   `$exists`: поле существует (`true`) или не существует (`false`)

**Логические операторы:**
*   `$or`: соответствует любому из условий в массиве (`[{<условие1>}, {<условие2>}]`).
*   `$and`: соответствует всем условиям в массиве (обычно используется для группировки условий к разным полям, но может быть и явным).

**Пример 1: Простой фильтр**
Найти всех пользователей по имени 'Alice'.
```javascript
const alices = await usersCollection.find({ name: 'Alice' });
```

**Пример 2: Использование операторов**
Найти всех пользователей старше 30 лет.
```javascript
const usersOver30 = await usersCollection.find({ age: { '$gt': 30 } });
```

**Пример 3: Сложный запрос с логикой**
Найти всех активных пользователей из Нью-Йорка ИЛИ всех пользователей с тегом 'vip'.
```javascript
const query = {
  '$or': [
    { city: 'New York', active: true },
    { tags: { '$in': ['vip'] } }
  ]
};
const results = await usersCollection.find(query);
```
**Важно:** WiseJSON DB автоматически пытается использовать существующие индексы для ускорения запросов по точному совпадению и по диапазону (`$gt`, `$lt` и т.д.).

### Поиск одного документа (`findOne`)

Работает аналогично `find`, но возвращает только **первый** найденный документ, удовлетворяющий условию, или `null`. Это более эффективно, если вам нужен только один результат.

*   **Параметры и Возвращаемое значение:** Аналогичны `find`, но возвращает `Promise<object | null>`.

**Пример:**
Найти одного пользователя с email 'admin@example.com'.
```javascript
const adminUser = await usersCollection.findOne({ email: 'admin@example.com' });
if (adminUser) {
  console.log('Администратор найден.');
}
```

### Проекции: Выбор полей

Иногда вам не нужны все поля документа, а только некоторые из них. Проекции позволяют указать, какие поля включить или исключить из результата. Это уменьшает объем передаваемых данных и может повысить производительность.

Проекции передаются вторым аргументом в `find` и `findOne`.
*   `{ field: 1 }`: Включить поле `field`.
*   `{ field: 0 }`: Исключить поле `field`.

**Правила:**
1.  Вы не можете смешивать режимы включения и исключения в одном запросе (кроме исключения `_id`).
2.  Поле `_id` включается по умолчанию. Чтобы его исключить, нужно явно указать `{ _id: 0 }`.

**Пример 1: Включение полей**
Получить только имена и email всех пользователей.
```javascript
const userList = await usersCollection.find({}, { name: 1, email: 1 });
// Результат: [{ _id: '...', name: '...', email: '...' }, ...]
```

**Пример 2: Включение полей без `_id`**
```javascript
const userListNoId = await usersCollection.find({}, { name: 1, email: 1, _id: 0 });
// Результат: [{ name: '...', email: '...' }, ...]
```

**Пример 3: Исключение полей**
Получить все данные о пользователях, кроме их тегов и статуса.
```javascript
const usersWithoutTags = await usersCollection.find({}, { tags: 0, status: 0 });
```

## Ускорение Поиска с Помощью Индексов

Индексы — это специальные структуры данных, которые позволяют базе данных находить документы гораздо быстрее, не перебирая всю коллекцию. WiseJSON DB автоматически использует индексы для запросов с точным совпадением и операторами диапазона (`$gt`, `$gte`, `$lt`, `$lte`).

### Как создать индекс (`createIndex`)

*   **`collection.createIndex(fieldName, options)`**: Создает индекс для указанного поля.
    *   `fieldName {string}`: Имя индексируемого поля.
    *   `options.unique {boolean}`: Если `true`, индекс будет уникальным, т.е. не допустит дубликатов значений в этом поле по всей коллекции. По умолчанию `false`.

**Пример:**
```javascript
// Создаем стандартный (неуникальный) индекс по полю 'city' для быстрого поиска по городам
await customersCollection.createIndex('city');

// Создаем уникальный индекс по полю 'email', чтобы не было двух пользователей с одинаковым email
await customersCollection.createIndex('email', { unique: true });
```

### Старые методы поиска по индексу (для обратной совместимости)

Хотя новый метод `find` автоматически использует индексы, для обратной совместимости и явного указания поиска по индексу сохранены старые методы:

*   **`collection.findByIndexedValue(fieldName, value)`**: Находит все документы с точным значением `value` в индексированном поле `fieldName`. Эквивалентно `find({ [fieldName]: value })`.
*   **`collection.findOneByIndexedValue(fieldName, value)`**: Находит один документ. Эквивалент `findOne({ [fieldName]: value })`.

### Управление индексами

*   **`collection.getIndexes()`**: Возвращает массив объектов, описывающих все существующие индексы в коллекции.
    ```javascript
    const indexes = await customersCollection.getIndexes();
    // Пример вывода: [{ fieldName: 'city', type: 'standard' }, { fieldName: 'email', type: 'unique' }]
    ```
*   **`collection.dropIndex(fieldName)`**: Удаляет индекс с указанного поля.
    ```javascript
    await customersCollection.dropIndex('city');
    ```